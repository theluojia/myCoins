<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的纪念币收藏（本地版）</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字体 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 收藏后的视觉效果：复选标记 */
        .coin-card.collected .coin-check-icon {
            opacity: 1;
        }
        /* 动画效果 */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        #save-status {
            animation: fade-in-out 3s ease-in-out;
        }
        /* 骨架屏动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .skeleton {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* 收藏概览抽屉样式 */
        .collection-overview {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .collection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            cursor: pointer;
        }
        .collection-summary {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .collection-count {
            margin-right: 1rem;
            font-weight: 600;
            color: #374151;
        }
        .progress-container {
            flex: 1;
            height: 8px;
            background-color: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color:  #3B82F6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .collection-details {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .collection-overview.expanded .collection-details {
            padding: 0 1rem 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        .overview-column h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #4B5563;
        }
        .stat-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1F2937;
        }
        /* 设置主题下拉框的固定宽度 */
        #themeFilter {
            width: 95px;
        }
        #denominationFilter {
            width: 95px;
        }
        #sizeFilter {
            width: 95px;
        }
        #metalFilter {
            width: 95px;
        }
        #yearFilter {
            width: 95px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans p-4 sm:p-8">
    <div class="max-w-7xl mx-auto py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800 leading-tight">我的纪念币收藏</h1>
            <p class="text-xl sm:text-2xl mt-2 text-gray-600">点击图片标记你已拥有的纪念币</p>
            
            <div id="collectionOverview" class="collection-overview mt-4 max-w-2xl mx-auto">
                <div class="collection-header" id="overviewHeader">
                    <div class="collection-summary">
                        <span class="collection-count" id="overviewCount">已收藏 0 / 0 枚</span>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <svg id="toggle-icon" class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>                    
                </div>

                <div class="collection-details" id="overviewDetails">
                    <div class="overview-grid">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-semibold text-gray-800 mb-2">按主题收藏</h3>
                            <ul id="themeStats"></ul>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-semibold text-gray-800 mb-2">按年份收藏</h3>
                            <ul id="yearStats"></ul>
                        </div>
                    </div>
                </div>
            </div>

           
            <div class="mt-4 max-w-2xl mx-auto">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索纪念币名称..." 
                           class="w-full rounded-md border border-gray-300 p-3 pl-10 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.416l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2 flex-wrap">

                <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                    <select id="themeFilter" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有主题</option>
                    </select>
                    <select id="denominationFilter" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有面额</option>
                    </select>
                    <select id="sizeFilter" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有大小</option>
                    </select>
                    <select id="metalFilter" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有材质</option>
                    </select>
                    <select id="yearFilter" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">所有年份</option>
                    </select>
                    <button id="sortOrderToggle" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md p-2 text-sm flex items-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414V16a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <p id="save-status" class="text-sm text-green-600 mt-2 opacity-0">已更新</p>
        </header>

        <main id="main-container">
        </main>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-800/80 to-blue-600/80 text-white py-3 px-4 transition-all duration-300">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                <div class="text-center md:text-left">
                    <p class="text-sm md:text-base opacity-90">此网页应用的所有数据均存储在本地浏览器中</p>
                </div>
                <div class="text-center">
                    <p class="text-sm md:text-base font-medium">Copyright © 2025 theluojia</p>
                </div>
                <div class="text-center md:text-right">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="text-sm md:text-base text-blue-200 hover:text-white transition-colors duration-200 underline decoration-dashed underline-offset-2">
                        CC BY-NC-SA 4.0
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let allCoinsData = []; 

        let myCollection = []; // 存储已收藏的纪念币ID
        const storageKey = 'myCoinCollection'; // 本地存储的键名
        let currentSortOrder = 'desc';
        let searchTimeout = null;

        const mainContainer = document.getElementById('main-container');
        const themeFilter = document.getElementById('themeFilter');
        const denominationFilter = document.getElementById('denominationFilter');
        const sizeFilter = document.getElementById('sizeFilter');
        const metalFilter = document.getElementById('metalFilter');
        const yearFilter = document.getElementById('yearFilter');
        const sortOrderToggle = document.getElementById('sortOrderToggle');
        const saveStatus = document.getElementById('save-status');
        const searchInput = document.getElementById('searchInput');


        // 加载本地收藏数据
        function loadCollection() {
            try {
                const savedCollection = localStorage.getItem(storageKey);
                if (savedCollection) {
                    myCollection = JSON.parse(savedCollection);
                } else {
                    myCollection = [];
                }
            } catch (e) {
                console.error("加载本地收藏数据失败:", e);
                myCollection = [];
            }
        }

        // 保存收藏数据到本地
        function saveCollection() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(myCollection));
                // 显示保存状态
                saveStatus.style.opacity = '1';
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                }, 2000);
            } catch (e) {
                console.error("保存本地收藏数据失败:", e);
            }
        }

        // 防抖函数 - 避免输入时频繁渲染
        function debounce(func, delay = 300) {
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // 渲染 UI
        function renderUI() {
            // 显示骨架屏
            mainContainer.innerHTML = `
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-center">
                    ${Array(10).fill().map(() => `
                        <div class="bg-gray-200 rounded-lg overflow-hidden skeleton h-64"></div>
                    `).join('')}
                </div>
            `;

            const selectedTheme = themeFilter.value;
            const selectedDenomination = denominationFilter.value;
            const selectedSize = sizeFilter.value;
            const selectedMetal = metalFilter.value;
            const selectedYear = yearFilter.value;
            const searchTerm = searchInput.value.toLowerCase().trim();

            // 筛选纪念币
            let filteredCoins = allCoinsData.filter(coin => {
                const matchesTheme = selectedTheme === '' || coin.theme === selectedTheme;
                const matchesDenomination = selectedDenomination === '' || coin.denomination === selectedDenomination;
                const matchesSize = selectedSize === '' || coin.size === selectedSize;
                const matchesMetal = selectedMetal === '' || coin.metal === selectedMetal;
                const matchesYear = selectedYear === '' || coin.year.toString() === selectedYear;
                const matchesSearch = searchTerm === '' || coin.name.toLowerCase().includes(searchTerm);
                return matchesTheme && matchesDenomination && matchesSize && matchesMetal && matchesYear && matchesSearch;
            });

            // 按年份分组
            const groupedCoins = filteredCoins.reduce((acc, coin) => {
                const year = coin.year;
                if (!acc[year]) {
                    acc[year] = [];
                }
                acc[year].push(coin);
                return acc;
            }, {});

            // 排序年份
            const sortedYears = Object.keys(groupedCoins).sort((a, b) => currentSortOrder === 'desc' ? b - a : a - b);

            // 收藏计数信息已移除

            // 清空容器准备渲染
            mainContainer.innerHTML = '';

            if (Object.keys(groupedCoins).length === 0) {
                let emptyMessage = '没有找到符合条件的纪念币';
                if (searchTerm) {
                    emptyMessage = `没有找到包含"${searchTerm}"的纪念币`;
                }
                mainContainer.innerHTML = `<p class="text-center text-gray-500 text-xl mt-10">${emptyMessage}</p>`;
                return;
            }

            // 渲染每个年份组
            sortedYears.forEach(year => {
                const yearSection = document.createElement('div');
                yearSection.className = 'my-8';
                yearSection.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-center md:text-left">${year}年</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-center"></div>
                `;
                const coinGrid = yearSection.querySelector('div.grid');

                groupedCoins[year].reverse();
                groupedCoins[year].forEach(coin => {
                    const isCollected = myCollection.includes(coin.id);
                    const coinCard = document.createElement('div');
                    coinCard.className = `coin-card flex flex-col items-center p-4 bg-gray-100 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105 cursor-pointer relative ${isCollected ? 'collected' : ''}`;
                    coinCard.setAttribute('data-coin-id', coin.id);

                    const imgClass = isCollected ? 'filter-none' : 'grayscale';
                    coinCard.innerHTML = `
                        <div class="relative w-full aspect-square">
                            <img 
                                src="${coin.imageUrl}" 
                                alt="${coin.name}" 
                                class="absolute top-0 left-0 w-full h-full object-contain rounded-lg ${imgClass} transition-all duration-500 ease-in-out" 
                                loading="lazy"
                                onerror="this.onerror=null;this.src='https://placehold.co/300x300/F0F0F0/888888?text=图片未找到'">
                            <div class="coin-check-icon absolute top-2 right-2 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-xl opacity-0 transition-opacity duration-300">✓</div>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="font-semibold text-lg">${coin.name}</p>
                            <p class="text-sm text-gray-600">${coin.denomination} / ${coin.size} / ${coin.metal}</p>
                        </div>
                    `;
                    coinGrid.appendChild(coinCard);

                    // 为卡片添加点击事件监听器
                    coinCard.addEventListener('click', () => toggleCollected(coin.id));
                });

                mainContainer.appendChild(yearSection);
            });
        }

        // 切换收藏状态并保存
        function toggleCollected(coinId) {
            const index = myCollection.indexOf(coinId);
            if (index > -1) {
                myCollection.splice(index, 1); // 移除
            } else {
                myCollection.push(coinId); // 添加
            }
            saveCollection();
            renderUI();
            updateCollectionOverview(); // 更新收藏概览
        }

        // 填充筛选下拉菜单
        function populateFilters(coins) {
            const themes = [...new Set(coins.map(coin => coin.theme))].sort();
            const denominations = [...new Set(coins.map(coin => coin.denomination))].sort();
            const sizes = [...new Set(coins.map(coin => coin.size))].sort((a, b) => parseInt(a) - parseInt(b));
            const metals = [...new Set(coins.map(coin => coin.metal))].sort();
            const years = [...new Set(coins.map(coin => coin.year))].sort((a, b) => b - a);

            themeFilter.innerHTML = '<option value="">所有主题</option>' + themes.map(t => `<option value="${t}">${t}</option>`).join('');
            denominationFilter.innerHTML = '<option value="">所有面额</option>' + denominations.map(d => `<option value="${d}">${d}</option>`).join('');
            sizeFilter.innerHTML = '<option value="">所有大小</option>' + sizes.map(s => `<option value="${s}">${s}</option>`).join('');
            metalFilter.innerHTML = '<option value="">所有材质</option>' + metals.map(m => `<option value="${m}">${m}</option>`).join('');
            yearFilter.innerHTML = '<option value="">所有年份</option>' + years.map(y => `<option value="${y}">${y}年</option>`).join('');

            themeFilter.addEventListener('change', renderUI);
            denominationFilter.addEventListener('change', renderUI);
            sizeFilter.addEventListener('change', renderUI);
            metalFilter.addEventListener('change', renderUI);
            yearFilter.addEventListener('change', renderUI);
            sortOrderToggle.addEventListener('click', () => {
                currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
                sortOrderToggle.innerHTML = currentSortOrder === 'desc' ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414V16a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3z" clip-rule="evenodd" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 17a1 1 0 01-.707-.293l-3-3a1 1 0 011.414-1.414L10 14.586V4a1 1 0 112 0v10.586l1.293-1.293a1 1 0 111.414 1.414l-3 3A1 1 0 0110 17z" clip-rule="evenodd" /></svg>`;
                renderUI();
            });
            
            // 添加搜索事件监听，使用防抖优化性能
            searchInput.addEventListener('input', debounce(renderUI));
        }

        // 更新收藏概览
        function updateCollectionOverview() {
            const totalCoins = allCoinsData.length;
            const collectedCoinsCount = myCollection.length;
            const completionRate = totalCoins > 0 ? (collectedCoinsCount / totalCoins) * 100 : 0;
            
            // 更新标题和进度条
            document.getElementById('overviewCount').textContent = `已收藏 ${collectedCoinsCount} / ${totalCoins} 枚`;
            document.getElementById('progressBar').style.width = `${completionRate}%`;
            
            // 按主题计算收藏完成度
            const themesData = {};
            allCoinsData.forEach(coin => {
                if (!themesData[coin.theme]) {
                    themesData[coin.theme] = { total: 0, collected: 0 };
                }
                themesData[coin.theme].total++;
                if (myCollection.includes(coin.id)) {
                    themesData[coin.theme].collected++;
                }
            });
            
            // 渲染主题统计
            const themeStatsContainer = document.getElementById('themeStats');
            themeStatsContainer.innerHTML = '';
            
            Object.entries(themesData)
                .sort((a, b) => b[1].collected / b[1].total - a[1].collected / a[1].total)
                .forEach(([theme, stats]) => {
                    const themeRate = (stats.collected / stats.total) * 100;
                    const statItem = document.createElement('li');
                    statItem.className = 'mb-2';
                    
                    const statHeader = document.createElement('div');
                    statHeader.className = 'flex justify-between items-center mb-1';
                    statHeader.innerHTML = `
                        <span class="text-sm text-gray-700">${theme}</span>
                        <span class="text-sm font-medium text-gray-900">${stats.collected}/${stats.total} (${themeRate.toFixed(0)}%)</span>
                    `;
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${themeRate}%`;
                    
                    progressContainer.appendChild(progressBar);
                    statItem.appendChild(statHeader);
                    statItem.appendChild(progressContainer);
                    
                    themeStatsContainer.appendChild(statItem);
                });
            
            // 按年份计算收藏完成度
            const yearsData = {};
            allCoinsData.forEach(coin => {
                if (!yearsData[coin.year]) {
                    yearsData[coin.year] = { total: 0, collected: 0 };
                }
                yearsData[coin.year].total++;
                if (myCollection.includes(coin.id)) {
                    yearsData[coin.year].collected++;
                }
            });
            
            // 渲染年份统计
            const yearStatsContainer = document.getElementById('yearStats');
            yearStatsContainer.innerHTML = '';
            
            Object.entries(yearsData)
                .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                .forEach(([year, stats]) => {
                    const yearRate = (stats.collected / stats.total) * 100;
                    const statItem = document.createElement('li');
                    statItem.className = 'mb-2';
                    
                    const statHeader = document.createElement('div');
                    statHeader.className = 'flex justify-between items-center mb-1';
                    statHeader.innerHTML = `
                        <span class="text-sm text-gray-700">${year}年</span>
                        <span class="text-sm font-medium text-gray-900">${stats.collected}/${stats.total} (${yearRate.toFixed(0)}%)</span>
                    `;
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${yearRate}%`;
                    
                    progressContainer.appendChild(progressBar);
                    statItem.appendChild(statHeader);
                    statItem.appendChild(progressContainer);
                    
                    yearStatsContainer.appendChild(statItem);
                });
        }
        
        // 切换收藏概览抽屉状态
        function toggleOverview() {
            const overviewElement = document.getElementById('collectionOverview');
            const toggleIcon = document.getElementById('toggle-icon');

            overviewElement.classList.toggle('expanded');
            
            if (overviewElement.classList.contains('expanded')) {
                toggleIcon.style.transform = 'rotate(180deg)';                
            } else {
                toggleIcon.style.transform = 'rotate(0deg)';                
            }
        }
        
        /**
         * 从指定的 JSON 文件加载数据。
         * @param {string} url - JSON 文件的 URL。
         * @returns {Promise<Array>} 返回一个 Promise，成功时解析为数据数组。
         */
        async function loadData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`网络请求失败，状态码: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('加载数据时出错:', error);
                throw error; // 继续抛出错误，让调用者可以捕获
            }
        }

        // 初始化应用
        window.onload = () => {
            // 在这里调用 loadData() 并处理返回的 Promise
            loadData('coin_data.json')
                .then(data => {
                    // 1. 数据加载成功后，将数据赋值给 allCoinsData
                    allCoinsData = data;

                    // 2. 然后，再调用所有依赖这些数据的初始化函数
                    loadCollection();
                    populateFilters(allCoinsData);
                    renderUI();
                    updateCollectionOverview();

                    // 3. 最后，添加事件监听器
                    document.getElementById('overviewHeader').addEventListener('click', toggleOverview);
                    document.getElementById('toggle-icon').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleOverview();
                    });

                })
                .catch(error => {
                    // 如果数据加载失败，可以在这里处理，例如显示错误消息给用户
                    console.error('无法初始化应用，因为数据加载失败。');
                });
        };

    </script>
</body>
</html>