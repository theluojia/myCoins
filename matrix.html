<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>纪念币点阵展示</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
  background-color: #f9f9f9;
  padding-bottom: 50px;
}

/* ================= 通用纪念币样式 ================= */

.coin {
  width: 800px;
  margin: 20px auto;
  border: 2px solid #000;
  background: #fff;
}

.header {
  text-align: center;
  border-bottom: 2px solid #000;
  padding: 8px 0;
}

.header h2 {
  margin: 0;
  font-size: 22px;
}

.header .code {
  font-size: 18px;
  margin-top: 4px;
}

.mints {
  display: flex;
}

.mint {
  flex: 1;
  border-right: 2px solid #000;
  padding: 40px 10px; /* 增加边距适配旋转 */
  display: flex;
  flex-direction: column;
  align-items: center;
}

.mint:last-child {
  border-right: none;
}

.mint-name {
  text-align: center;
  margin-bottom: 20px;
  font-size: 16px;
  font-weight: bold;
}

/* ================= 点阵样式 ================= */

.matrix {
  display: grid;
  grid-template-rows: repeat(10, 18px);
  grid-auto-flow: column;
  gap: 2px;
  justify-content: center;
  /* 关键：增加过渡动画 */
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  will-change: transform;
}

.cell {
  width: 18px;
  height: 18px;
  border: 1px solid #e0e0e0;
}

.cell.black {
  background: #000;
}

/* 分析模式下的专属颜色 */
.analysis-active .mint-0 .cell.black.diff { background: #ff4d4f; border-color: #ff4d4f; }
.analysis-active .mint-1 .cell.black.diff { background: #1890ff; border-color: #1890ff; }
.analysis-active .mint-2 .cell.black.diff { background: #52c41a; border-color: #52c41a; }

.gap-column {
  width: 8px;
  grid-row: 1 / -1;
}

/* ================= 悬浮按钮 (风格保持一致) ================= */

.rotate-float-btn, .analysis-float-btn {
  position: fixed;
  right: 40px;
  width: 56px;
  height: 56px;
  background-color: #ffffff;
  color: #000;
  border-radius: 50%;
  border: 2px solid #000;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

/* 两个按钮上下排列 */
.rotate-float-btn { top: calc(50% - 35px); }
.analysis-float-btn { top: calc(50% + 35px); }

.rotate-float-btn:hover, .analysis-float-btn:hover {
  background-color: #000;
  color: #fff;
}

.rotate-float-btn svg, .analysis-float-btn svg {
  width: 28px;
  height: 28px;
  fill: currentColor;
}

/* ================= 其他 UI ================= */

.export-all {
  width: 800px;
  margin: 30px auto 10px;
  text-align: right;
}

.export-all button {
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  background: #fff;
  border: 1px solid #000;
}

.export-all button:hover {
  background: #eee;
}

.decorator {
  width: 800px;
  margin: 20px auto;
  text-align: center;
  color: #999;
}

.decorator::before,
.decorator::after {
  content: "";
  display: inline-block;
  width: 200px;
  border-top: 1px dashed #bbb;
  vertical-align: middle;
  margin: 0 12px;
}

.lab {
  width: 800px;
  margin: 20px auto;
  border: 2px solid #000;
  background: #fff;
}

.lab-header {
  text-align: center;
  border-bottom: 2px solid #000;
  padding: 8px 0;
  font-size: 20px;
  font-weight: bold;
}

.lab-input {
  padding: 12px;
}

.lab-input label {
  display: block;
  margin-top: 10px;
  font-size: 14px;
}

.lab-input input,
.lab-input textarea {
  width: 100%;
  box-sizing: border-box;
  margin-top: 4px;
  padding: 6px;
  font-family: monospace;
  font-size: 14px;
}

.lab-input textarea {
  height: 110px;
}

.version-block {
  border: 1px dashed #aaa;
  padding: 8px;
  margin-top: 12px;
}

.lab-actions {
  width: 800px;
  margin: 30px auto 10px;
  text-align: right;
}

.lab-actions button {
  margin-right: 10px;
  padding: 6px 14px;
  font-size: 14px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="app"></div>

<button class="rotate-float-btn" onclick="rotateAllMatrices()" title="顺时针旋转90度">
  <svg t="1569683458761" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10582" xmlns:xlink="http://www.w3.org/1999/xlink">
    <path d="M480.5 251.2c13-1.6 25.9-2.4 38.8-2.5v63.9c0 6.5 7.5 10.1 12.6 6.1L660 217.6c4-3.2 4-9.2 0-12.3l-128-101c-5.1-4-12.6-0.4-12.6 6.1l-0.2 64c-118.6 0.5-235.8 53.4-314.6 154.2-69.6 89.2-95.7 198.6-81.1 302.4h74.9c-0.9-5.3-1.7-10.7-2.4-16.1-5.1-42.1-2.1-84.1 8.9-124.8 11.4-42.2 31-81.1 58.1-115.8 27.2-34.7 60.3-63.2 98.4-84.3 37-20.6 76.9-33.6 119.1-38.8z" p-id="10583"></path>
    <path d="M880 418H352c-17.7 0-32 14.3-32 32v414c0 17.7 14.3 32 32 32h528c17.7 0 32-14.3 32-32V450c0-17.7-14.3-32-32-32z m-44 402H396V494h440v326z" p-id="10584"></path>
  </svg>
</button>

<button class="analysis-float-btn" onclick="toggleAnalysis()" title="差异颜色分析">
  <svg id="Capa_1" version="1.1" viewBox="0 0 362.5 442" xmlns="http://www.w3.org/2000/svg">
    <g><path d="M134.4,214.6c-16.6-5.5-30-17.2-37.8-32.8c-16.1-32.3-3-71.6,29.2-87.8l-13.2-26.4C65.7,91,46.7,148.2,70.1,195   c16.6,33.2,50.2,52.4,85.1,52.4c14.3,0,28.7-3.2,42.3-10L184.3,211C168.7,218.8,150.9,220.1,134.4,214.6z"/><path d="M353.9,363.1l-80.3-120c9.5-12.7,17.2-27.2,22.5-43.1C322.6,120.5,279.5,34.3,200,7.8C120.5-18.7,34.3,24.5,7.8,104   c-26.5,79.5,16.7,165.7,96.2,192.2c15.9,5.3,32,7.8,47.9,7.8c12.7,0,25.2-1.6,37.3-4.7l80.4,120.3c9.8,14.6,25.9,22.5,42.3,22.5   c9.7,0,19.5-2.8,28.1-8.5C363.2,417.9,369.5,386.4,353.9,363.1z M113.3,268.1c-64.1-21.3-98.8-90.8-77.5-154.9   c17.1-51.3,65-83.8,116.3-83.8c12.8,0,25.8,2,38.6,6.3c64.1,21.3,98.8,90.8,77.5,154.9C246.8,254.7,177.3,289.5,113.3,268.1z  M332.5,395.4c-1.1,5.6-4.3,10.4-9,13.5c-9.7,6.5-22.9,3.9-29.4-5.8l-76.4-114.2c12.8-6.1,24.7-14,35.4-23.5l76.3,114.1   C332.5,384.2,333.6,389.9,332.5,395.4z"/></g>
  </svg>
</button>

<div class="export-all">
  <button onclick="exportAllCoins()">保存上方所有表格为图片</button>
</div>

<div class="decorator">◆ ◆ ◆</div>

<div class="lab">
  <div class="lab-header">点阵试验场</div>
  <div class="lab-input">
    <label>纪念币名称</label>
    <input id="lab-name" value="2026年贺岁（丙午）">
    <label>纪念币编号</label>
    <input id="lab-code" value="JB126">
    <div class="version-block">
      <strong>版本 1</strong>
      <label>纪念币版本</label>
      <input id="mint-1" value="沈阳">
      <label>点阵数据</label>
      <textarea id="data-1">["1111111111","1110101011","1001010011","","1111111111","1010110011"]</textarea>
    </div>
    <div class="version-block">
      <strong>版本 2</strong>
      <label>纪念币版本</label>
      <input id="mint-2" value="上海">
      <label>点阵数据</label>
      <textarea id="data-2">["1111111111","1110101001","1001010001","","1111111111","1010110011"]</textarea>
    </div>
    <div class="version-block">
      <strong>版本 3</strong>
      <label>纪念币版本</label>
      <input id="mint-3" value="南京">
      <label>点阵数据</label>
      <textarea id="data-3">["1111111111","1110101001","1001010011","","1111111111","1010110011"]</textarea>
    </div>
  </div>
</div>

<div class="lab-actions">
  <button onclick="generateLab()">生成点阵</button>
  <button onclick="exportPreview()">保存成图片</button>
</div>

<script>
/* 全局旋转角度累计 */
let globalDegree = 0; 

/* ================= 数据加载 ================= */

fetch("matrix.json")
  .then(res => res.json())
  .then(data => renderCoins(data.coins))
  .catch(() => console.log("等待输入数据..."));

function renderCoins(coins) {
  const app = document.getElementById("app");
  coins.forEach(coin => {
    app.appendChild(buildCoin(coin.name, coin.code, coin.mints));
  });
}

/* ================= 核心构建逻辑 ================= */

function createMatrix(data, mintIndex, allMintsData) {
  const matrix = document.createElement("div");
  matrix.className = `matrix mint-${mintIndex}`;
  matrix.style.transform = `rotate(${globalDegree}deg)`;

  data.forEach((col, colIdx) => {
    if (col === "") {
      const gap = document.createElement("div");
      gap.className = "gap-column";
      matrix.appendChild(gap);
      return;
    }
    col.split("").forEach((bit, rowIdx) => {
      const cell = document.createElement("div");
      cell.className = "cell" + (bit === "1" ? " black" : "");
      
      // 差异分析预处理：标记出非共有的点
      if (bit === "1" && allMintsData) {
        const isCommon = allMintsData.every(m => {
          const targetCol = m.data[colIdx];
          return targetCol && targetCol[rowIdx] === "1";
        });
        if (!isCommon) cell.classList.add("diff");
      }

      matrix.appendChild(cell);
    });
  });
  return matrix;
}

function buildCoin(name, code, mints) {
  const coin = document.createElement("div");
  coin.className = "coin";
  coin.innerHTML = `<div class="header"><h2>${name}</h2><div class="code">${code}</div></div>`;
  const mintsDiv = document.createElement("div");
  mintsDiv.className = "mints";

  mints.forEach((m, idx) => {
    const mintDiv = document.createElement("div");
    mintDiv.className = "mint";
    mintDiv.innerHTML = `<div class="mint-name">${m.name}</div>`;
    mintDiv.appendChild(createMatrix(m.data, idx, mints));
    mintsDiv.appendChild(mintDiv);
  });

  coin.appendChild(mintsDiv);
  return coin;
}

/* ================= 旋转逻辑 ================= */

function rotateAllMatrices() {
  globalDegree += 90;
  const allMatrices = document.querySelectorAll('.matrix');
  allMatrices.forEach(m => {
    m.style.transform = `rotate(${globalDegree}deg)`;
  });
}

/* ================= 差异分析切换 ================= */

function toggleAnalysis() {
  document.body.classList.toggle('analysis-active');
}

/* ================= 试验场 ================= */

function generateLab() {
  const name = document.getElementById("lab-name").value;
  const code = document.getElementById("lab-code").value;
  const mints = [];

  [1,2,3].forEach(i => {
    const mint = document.getElementById(`mint-${i}`).value.trim();
    const dataText = document.getElementById(`data-${i}`).value.trim();
    if (!mint || !dataText) return;
    try { mints.push({ name: mint, data: JSON.parse(dataText) }); } catch(e) {}
  });

  const old = document.getElementById("lab-generated");
  if (old) old.remove();

  const container = document.createElement("div");
  container.id = "lab-generated";
  document.body.appendChild(container);
  container.appendChild(buildCoin(name, code, mints));
}

/* ================= 导出 ================= */

function saveCanvas(el, filename, callback) {
  html2canvas(el, {
    scale: 3,
    backgroundColor: "#fff",
    logging: false
  }).then(canvas => {
    const a = document.createElement("a");
    a.download = filename;
    a.href = canvas.toDataURL("image/png");
    a.click();
    if(callback) callback();
  });
}

function exportPreview() {
  const wrapper = document.getElementById("lab-generated");
  if (!wrapper) return alert("请先生成");
  saveCanvas(wrapper.querySelector(".coin"), "preview.png");
}

function exportAllCoins() {
  const coins = document.querySelectorAll("#app .coin");
  if (!coins.length) return alert("无可导出内容");

  const temp = document.createElement("div");
  temp.style.cssText = "background:#fff; padding:20px; display:inline-block;";
  if (document.body.classList.contains('analysis-active')) temp.classList.add('analysis-active');
  
  coins.forEach(c => temp.appendChild(c.cloneNode(true)));
  document.body.appendChild(temp);
  
  temp.querySelectorAll('.matrix').forEach((m) => {
    m.style.transform = `rotate(${globalDegree}deg)`;
  });

  saveCanvas(temp, "all-coins.png", () => temp.remove());
}
</script>

</body>
</html>